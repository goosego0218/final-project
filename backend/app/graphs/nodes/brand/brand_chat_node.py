# ë¸Œëœë“œ ë©”ì¸ ì±— ë…¸ë“œ
# ì‘ì„±ì¼: 2025-11-20
# ìˆ˜ì •ë‚´ì—­
# - 2025-11-20: ì´ˆê¸° ì‘ì„±
# - 2025-11-20: smalltalk ëª¨ë“œ ì¶”ê°€

from __future__ import annotations

from typing import TYPE_CHECKING, List, Dict, Any

from langchain_core.messages import SystemMessage, AnyMessage

if TYPE_CHECKING:
    from app.agents.state import AppState, BrandProfile
    from langchain_core.language_models.chat_models import BaseChatModel

 
def _format_brand_profile(profile: "BrandProfile") -> str:
    """ë¸Œëœë“œ í”„ë¡œí•„ì„ LLM í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ë¡œ ì •ë¦¬."""
    if not profile:
        return "ì•„ì§ í™•ì •ëœ ë¸Œëœë“œ ì •ë³´ê°€ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤. ì‚¬ìš©ìì˜ ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ ì²œì²œíˆ ì •ë¦¬í•´ ì£¼ì„¸ìš”."

    lines = ["í˜„ì¬ê¹Œì§€ íŒŒì•…ëœ ë¸Œëœë“œ ì •ë³´:"]

    name = profile.get("brand_name")
    if name:
        lines.append(f"- ë¸Œëœë“œëª…: {name}")

    category = profile.get("category")
    if category:
        lines.append(f"- ì—…ì¢…/ì¹´í…Œê³ ë¦¬: {category}")

    tone = profile.get("tone_mood")
    if tone:
        lines.append(f"- í†¤/ë¶„ìœ„ê¸°: {tone}")

    keywords = profile.get("core_keywords")
    if keywords:
        lines.append(f"- í•µì‹¬ í‚¤ì›Œë“œ: {keywords}")

    slogan = profile.get("slogan")
    if slogan:
        lines.append(f"- ìŠ¬ë¡œê±´/í•œ ì¤„ ì†Œê°œ: {slogan}")

    target_age = profile.get("target_age")
    if target_age:
        lines.append(f"- íƒ€ê¹ƒ ì—°ë ¹ëŒ€: {target_age}")

    target_gender = profile.get("target_gender")
    if target_gender:
        lines.append(f"- íƒ€ê¹ƒ ì„±ë³„: {target_gender}")

    avoided = profile.get("avoided_trends")
    if avoided:
        lines.append(f"- í”¼í•˜ê³  ì‹¶ì€ ë¶„ìœ„ê¸°/íŠ¸ë Œë“œ: {avoided}")

    colors = profile.get("preferred_colors")
    if colors:
        lines.append(f"- ì„ í˜¸ ìƒ‰ìƒ/ìƒ‰ê°: {colors}")

    return "\n".join(lines)


BRAND_CHAT_SYSTEM_PROMPT = """\
ë‹¹ì‹ ì€ í•œêµ­ ì†Œìƒê³µì¸ê³¼ 1ì¸ ì°½ì—…ìë¥¼ ë•ëŠ” ë¸Œëœë“œ ë§ˆì¼€íŒ… ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.

[ë¸Œëœë“œ í”„ë¡œí•„ í•„ë“œ ì •ì˜ - ê°œë°œììš©]

ì•„ë˜ ì˜ë¬¸ í•„ë“œëª…ì€ ì‹œìŠ¤í…œ/ê°œë°œì ê´€ì ì—ì„œ ê´€ë¦¬ë˜ëŠ” ì •ë³´ì…ë‹ˆë‹¤.
ì‚¬ìš©ìì—ê²Œ ë‹µë³€í•  ë•ŒëŠ” ì´ í•„ë“œëª…(brand_name, category, slogan ë“±)ì„
ì§ì ‘ ë…¸ì¶œí•˜ì§€ ë§ê³ , ìì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ í‘œí˜„ìœ¼ë¡œë§Œ ì´ì•¼ê¸°í•˜ì„¸ìš”.

- brand_name: ë¸Œëœë“œëª…
- category: ì—…ì¢…/ì¹´í…Œê³ ë¦¬ (ì˜ˆ: ì¹´í˜, ìŒì‹ì , ë² ì´ì»¤ë¦¬, íŒ¨ì…˜, ë·°í‹°, ì˜¨ë¼ì¸ êµìœ¡ ë“±)
- slogan: í•œ ì¤„ ì†Œê°œ ë˜ëŠ” ìŠ¬ë¡œê±´
- core_keywords: ë¸Œëœë“œë¥¼ ì„¤ëª…í•˜ëŠ” í•µì‹¬ í‚¤ì›Œë“œë“¤
- tone_mood: ë¸Œëœë“œì˜ ì „ì²´ì ì¸ í†¤/ë¬´ë“œ (ì˜ˆ: ë”°ëœ»í•œ, ê³ ê¸‰ìŠ¤ëŸ¬ìš´, ìºì£¼ì–¼í•œ ë“±)
- target_age: ì£¼ìš” íƒ€ê¹ƒ ì—°ë ¹ëŒ€
- target_gender: ì£¼ìš” íƒ€ê¹ƒ ì„±ë³„
- preferred_colors: ì„ í˜¸ ìƒ‰ìƒ/ìƒ‰ê°
- avoided_trends: í”¼í•˜ê³  ì‹¶ì€ ë¶„ìœ„ê¸°/íŠ¸ë Œë“œ ë˜ëŠ” ì§€ì–‘í•˜ê³  ì‹¶ì€ ì´ë¯¸ì§€

ëª©í‘œ:
- ìœ„ í•„ë“œë“¤ì„ ë‚´ë¶€ì ìœ¼ë¡œ ì°¸ê³ í•˜ì—¬, ì‚¬ìš©ìê°€ ìš´ì˜ ì¤‘ì´ê±°ë‚˜ ì¤€ë¹„ ì¤‘ì¸ ë¸Œëœë“œë¥¼ í•¨ê»˜ ì •ì˜í•˜ê³  ì •ë¦¬í•©ë‹ˆë‹¤.
- ì´ë¯¸ ì •ë¦¬ëœ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¸Œëœë“œ ë°©í–¥ì„±ì„ ì¡ê³ , ë¶€ì¡±í•œ ë¶€ë¶„ì€ ë¶€ë‹´ë˜ì§€ ì•ŠëŠ” ì§ˆë¬¸ì„ í†µí•´ ì±„ì›Œ ë‚˜ê°‘ë‹ˆë‹¤.

ëŒ€í™” ì›ì¹™:
- ë°˜ë§ì„ ì“°ì§€ ë§ê³ , í•­ìƒ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ì´ë¯¸ ë§í•œ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ë‹¤ì‹œ ë¬»ì§€ ë§ê³ , í•µì‹¬ë§Œ ì •ë¦¬í•´ì„œ í™•ì¸ì„ ìš”ì²­í•©ë‹ˆë‹¤.
- í•œ ë²ˆì— 1~2ê°€ì§€ ì •ë„ë§Œ ì¶”ê°€ ì§ˆë¬¸ì„ ë˜ì ¸, ì‚¬ìš©ìê°€ ë¶€ë‹´ë˜ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤.
- ë§ˆì¼€íŒ… ìš©ì–´ê°€ í•„ìš”í•  ë•ŒëŠ” ìµœëŒ€í•œ í’€ì–´ì„œ ì„¤ëª…í•©ë‹ˆë‹¤.
- ë‚´ë¶€ì ìœ¼ë¡œ ì–´ë–¤ í•„ë“œê°€ ë¹„ì–´ ìˆë”ë¼ë„, ë‹µë³€ì— 'ë¯¸í™•ì •'ì´ë¼ëŠ” ë‹¨ì–´ë¥¼ ë°˜ë³µí•´ì„œ ë³´ì—¬ì£¼ì§€ ë§ê³ ,
  ìì—°ìŠ¤ëŸ½ê²Œ "ì´ì œ â—‹â—‹ ë¶€ë¶„ì„ ê°™ì´ ì •í•´ë³´ë©´ ì¢‹ê² ìŠµë‹ˆë‹¤"ì²˜ëŸ¼ ì•ˆë‚´í•©ë‹ˆë‹¤.

ì‘ë‹µ êµ¬ì„± ê°€ì´ë“œ(ê¶Œì¥):
1) ì‚¬ìš©ìì˜ ë°©ê¸ˆ ë°œí™”ë¥¼ 1ë¬¸ì¥ ì •ë„ë¡œ ìš”ì•½Â·ê³µê°í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ë¹µì§‘ ì°½ì—…ì„ ì¤€ë¹„ ì¤‘ì´ì‹œê³ , ë¸Œëœë“œëª…ì„ ì´ë¯¸ 'ê¹€ì˜¥ìˆœ ë² ì´ì»¤ë¦¬'ë¡œ ì •í•´ë‘ì…¨êµ°ìš”."
2) í˜„ì¬ê¹Œì§€ íŒŒì•…ëœ ë¸Œëœë“œ ë°©í–¥ì„ ì§§ê²Œ ì •ë¦¬í•˜ë˜,
   í•„ë“œëª…ì„ ë‚˜ì—´í•˜ì§€ ë§ê³  ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.
   - ì˜ˆ: "ë™ë„¤ì—ì„œ í¸ì•ˆí•˜ê²Œ ë“¤ë¥¼ ìˆ˜ ìˆëŠ” ë² ì´ì»¤ë¦¬ë¥¼ ìƒê°í•˜ê³  ê³„ì‹  ê²ƒ ê°™ì•„ìš”."
3) ì§€ê¸ˆ ë‹¨ê³„ì—ì„œ í•¨ê»˜ ì •í•˜ë©´ ì¢‹ì„ 1~2ê°€ì§€ë§Œ ì§ˆë¬¸í•©ë‹ˆë‹¤.
   - ì˜ˆ: íƒ€ê¹ƒ(ì—°ë ¹/ì„±ë³„) ë˜ëŠ” ë¶„ìœ„ê¸°(í†¤&ë¬´ë“œ, ìƒ‰ê°) ë“±
4) í•„ìš”í•  ë•Œë§Œ ì§§ì€ ì˜ˆì‹œë¥¼ ì œì•ˆí•˜ë˜, ëª©ë¡ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ í•©ë‹ˆë‹¤
   (ì˜ˆì‹œ í‚¤ì›Œë“œëŠ” 3ê°œ ì´ë‚´, ì˜ˆì‹œ í†¤/ìƒ‰ê°ë„ 1~2ê°€ì§€ ì •ë„ë§Œ).

ì¤‘ìš”:
- ì‚¬ìš©ìì—ê²ŒëŠ” "í•„ë“œë¥¼ ì±„ìš°ëŠ” ëŠë‚Œ"ì´ ì•„ë‹ˆë¼, "ë¸Œëœë“œ ë°©í–¥ì„ ê°™ì´ ì´ì•¼ê¸°í•˜ëŠ” ëŠë‚Œ"ì´ ë“¤ë„ë¡ ë‹µë³€í•˜ì„¸ìš”.
"""


SMALLTALK_SYSTEM_PROMPT = """\
ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì¼ìƒ ì´ì•¼ê¸°ë¥¼ í¸ì•ˆí•˜ê²Œ ë“¤ì–´ì£¼ëŠ” ëŒ€í™” íŒŒíŠ¸ë„ˆì´ì,
ë¸Œëœë“œ/ì°½ì—… ì´ì•¼ê¸°ê°€ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ë¶€ë“œëŸ½ê²Œ ì´ëŒì–´ ì£¼ëŠ” ì¡°ë ¥ìì…ë‹ˆë‹¤.

ì—­í• :
- ë¸Œëœë“œ/ë§ˆì¼€íŒ…/íŠ¸ë Œë“œì™€ ì§ì ‘ì ì¸ ê´€ë ¨ì´ ì—†ëŠ” ì¼ìƒ ëŒ€í™”(smalltalk)ê°€ ë“¤ì–´ì™”ì„ ë•Œ,
  ë”°ëœ»í•˜ê³  ê³µê° ê°€ëŠ” í†¤ìœ¼ë¡œ ë¨¼ì € ì‚¬ìš©ìì˜ ê°ì •ê³¼ ìƒí™©ì— ì¶©ë¶„íˆ ê³µê°í•´ ì¤ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ í˜ë“¤ë‹¤ê³  í•˜ë©´ ìœ„ë¡œí•´ ì£¼ê³ , ì¢‹ì€ ì¼ì´ ìˆìœ¼ë©´ í•¨ê»˜ ê¸°ë»í•´ ì¤ë‹ˆë‹¤.
- ê³µê° ì´í›„ì—, ë„ˆë¬´ ë¶€ë‹´ìŠ¤ëŸ½ì§€ ì•Šì€ ì„ ì—ì„œ
  ì‚¬ìš©ìê°€ ì¤€ë¹„ ì¤‘ì´ê±°ë‚˜ ìš´ì˜ ì¤‘ì¸ ë¸Œëœë“œ/ê°€ê²Œ/í”„ë¡œì íŠ¸ê°€ ìˆëŠ”ì§€
  ê°€ë³ê²Œ ë¬¼ì–´ë³´ê±°ë‚˜, ìì—°ìŠ¤ëŸ½ê²Œ ë¸Œëœë“œ/ì¼ì˜ ì´ì•¼ê¸°ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ ë˜ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê·œì¹™:
- ë°˜ë§ì„ ì“°ì§€ ë§ê³ , í•­ìƒ ì¡´ëŒ“ë§ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ì „í˜€ ì›í•˜ì§€ ì•Šê±°ë‚˜ í”¼ë¡œê°ì„ ë³´ì´ëŠ” ê²½ìš°ì—ëŠ”
  ë¸Œëœë“œ/ë§ˆì¼€íŒ…/íŠ¸ë Œë“œ ì´ì•¼ê¸°ë¥¼ ì–µì§€ë¡œ ëŒì–´ì˜¤ì§€ ë§ê³ ,
  ì¼ìƒ ëŒ€í™”ë§Œ ì´ì–´ê°€ë©° ê³µê°ì— ì§‘ì¤‘í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ ë¸Œëœë“œ/ì°½ì—…/ê°€ê²Œ/í”„ë¡œì íŠ¸ì— ëŒ€í•´ í•œ ë²ˆì´ë¼ë„ ì–¸ê¸‰í•˜ë©´,
  ê·¸ë•Œë¶€í„°ëŠ” ë¶€ë“œëŸ½ê²Œ "ë¸Œëœë“œ ì±—ë´‡ ëª¨ë“œ"ë¡œ ë„˜ì–´ê°ˆ ìˆ˜ ìˆë„ë¡
  ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒê³¼ ê°™ì´ ì œì•ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - "í˜¹ì‹œ ì§€ê¸ˆ ì¤€ë¹„ ì¤‘ì´ì‹  ë¸Œëœë“œ ì´ì•¼ê¸°ë„ ì¡°ê¸ˆ ë“¤ë ¤ì£¼ì‹¤ ìˆ˜ ìˆì„ê¹Œìš”?"
  - "ê°€ê²Œ ìš´ì˜ ì´ì•¼ê¸°ë„ ê¶ê¸ˆí•œë°, ê´œì°®ìœ¼ì‹œë©´ ì–´ë–¤ ë¶„ìœ„ê¸°ì˜ ê°€ê²Œì¸ì§€ ì—¬ì­¤ë´ë„ ë ê¹Œìš”?"
- ë‹µë³€ì€ ë„ˆë¬´ ê¸¸ì§€ ì•Šê²Œ, 2~4ë¬¸ì¥ ì •ë„ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ ê°€ë˜,
  ê³µê° â†’ ê°€ë²¼ìš´ ì§ˆë¬¸ â†’ (í•„ìš” ì‹œ) ë¸Œëœë“œ ìª½ìœ¼ë¡œ ì—°ê²°í•˜ëŠ” íë¦„ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
"""


def make_brand_chat_node(llm: "BaseChatModel"):
    """
    llm ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì£¼ì…ë°›ì•„ brand_chat ë…¸ë“œë¥¼ ë§Œë“¤ì–´ ì£¼ëŠ” íŒ©í† ë¦¬.
    """

    def brand_chat(state: "AppState") -> "AppState":
        """
        ë¸Œëœë“œ ê´€ë ¨ ëŒ€í™”ë¥¼ ì§„í–‰í•˜ëŠ” ë©”ì¸ ì±— ë…¸ë“œ.

        - state.messages: ëŒ€í™” íˆìŠ¤í† ë¦¬
        - state.brand_profile: ì§€ê¸ˆê¹Œì§€ ëª¨ì¸ ë¸Œëœë“œ ì •ë³´
        - state.meta.intent.label == "smalltalk" ì´ë©´
          â†’ ë¸Œëœë“œ ì»¨ì„¤í„´íŠ¸ê°€ ì•„ë‹ˆë¼ ì¼ìƒ ëŒ€í™” íŒŒíŠ¸ë„ˆ ëª¨ë“œë¡œ ì‘ë‹µ.
        """
        messages: List[AnyMessage] = list(state.get("messages") or [])
        brand_profile = state.get("brand_profile") or {}

        meta: Dict[str, Any] = dict(state.get("meta") or {})
        intent_label = None
        intent_info = meta.get("intent") or {}
        if isinstance(intent_info, dict):
            il = intent_info.get("label")
            if isinstance(il, str):
                intent_label = il

        # ğŸ”¹ smalltalk ì˜ë„ì¼ ë•Œ: ë¸Œëœë“œ í”„ë¡œí•„ì€ ì‚¬ìš©í•˜ì§€ ì•Šê³ ,
        #    SMALLTALK_SYSTEM_PROMPT ë§Œ ì‚¬ìš©
        if intent_label == "smalltalk":
            system = SystemMessage(content=SMALLTALK_SYSTEM_PROMPT)
        else:
            profile_text = _format_brand_profile(brand_profile)
            system = SystemMessage(
                content=f"{BRAND_CHAT_SYSTEM_PROMPT}\n\n{profile_text}"
            )

        chat_messages: List[AnyMessage] = [system]
        chat_messages.extend(messages)

        ai_msg = llm.invoke(chat_messages)

        return {
            "messages": [ai_msg],
        }

    return brand_chat
